---
title: "Power Problem Set"
author: "Karla Garibay Garcia"
date: "5/24/2022"
output: html_document
---

```{r setup, include=FALSE}
library(DeclareDesign)
library(truncnorm) #for truncated distribution
library(knitr)
library(ggplot2)
library(kableExtra)
```

## Declare_population()

```{r population, echo=TRUE}
set.seed(228) #Setting seed for randomization
population <- declare_population(
  village = add_level(N=500, #The population consists of 500 waterways.
    water_quality=rtruncnorm(n=N, a=0.38, b=8.21, 
                            mean=1.1, sd=0.1), 
    u=rnorm(n=N, mean=1.1, sd=0.1)) #waterway-level variability (for calculating the treatment effect
)
```

## Population descriptives

```{r population-see, echo=TRUE, fig.height=5.5}
pop <- population() 
hist(pop[,2], xlab="Baseline Water Quality Index", 
     main="Baseline", cex=24) #Plots histogram of baseline water quality index the population. Note the truncated normal distribution.
```

## declare_potential_outcomes()

Declare the full schedule of potential outcomes $Y(1)$ and $Y(0)$ under an assumption about the effect size of interest.

```{r po, echo=TRUE}
eff_size <- -0.19 #The treated waterways displayed a -0.19 lower water quality index 
potential_outcomes <- 
  declare_potential_outcomes(
    Y_D_0=water_quality + u,
    Y_D_1=water_quality + eff_size + u) 
```


## Potential outcomes descriptives

```{r po-see, echo=TRUE}
po <- potential_outcomes(pop) 
kable(po[1:5,], digits=1)
```


## declare_sampling()


```{r sample, echo=TRUE}
samp_size <- 100 # Starting with a sample size of 100.
sampling <- 
  declare_sampling(S = draw_rs(N=N, n=samp_size)) 
sam <- sampling(po) #PH: Delcaring sampling protocol.
kable(sam[1:5,c(1:2,4:6)], row.names = FALSE,
      digits = 1)
```


## declare_assignment()


```{r assign, echo=TRUE}
assigning <- 
  declare_assignment(D = conduct_ra(N=N, prob=0.5)) #specifying treatment assignment process. We're using simple, complete random assignment where each unit in our sample of 100 has an equal probability of being assigned to treatment and control. In expectation, we should get 50 treated and 50 control villages from this code.
assigned <- assigning(sam) #Delcaring randomization.
prop.table(table(assigned$D)) #Checking that the randomization was good. This shows that 50% of our villages are in treatment, and 50% of them are in control.
```


## Assessing balance


```{r violin, echo=FALSE, fig.height=6}
ggplot(data=assigned, aes(x=as.factor(D), y=water_quality)) +
geom_violin(aes(fill=as.factor(D), color=as.factor(D))) +
theme_minimal(base_size = 24) + xlab("Assignment")
```

## declare_reveal()

```{r reveal, echo=TRUE}
revealing <- declare_reveal(assignment_variables=D) #Revealing each sampled unit's potential outcomes based on their assignment to treatment.
```

## declare_inquiry()

```{r estimand, echo=TRUE}
estimand <- declare_inquiry(ATE = eff_size) #Declaring our estimand here, which is equal to the effect size (-0.19, or the treatment effect)
estimand(po)
```


## declare_estimator()

```{r estimator, echo=TRUE}
dim <- declare_estimator(Y ~ D, #Difference in means estimator because this equation is going to estimate the difference in the average level of endline water quality indexes between treatment and control waterways.
                         inquiry = estimand,
                         model = difference_in_means, 
                         label = "DIM")

did <- declare_estimator(Y - water_quality ~ D, #Differences in differences estimator because this equation estimates the difference in the difference between endline and basline water quality indexes between treatement and control waterways.
                         inquiry = estimand,
                         model = difference_in_means, 
                         label = "DID")
```


## declare_design()

```{r design, echo=TRUE}
design <- population + potential_outcomes + sampling +
          assigning + revealing + estimand + dim + did 
```


## diagnose_design()

```{r diagnosis, cache=TRUE}
diagnosis <- diagnose_design(design, sims=1000) #Diagnosing the design over 1000 simulations to estimate bias and to calculate power.
diagnosis$diagnosands_df[,c(1,3,5,9,11)] %>%
  kable() 

diagnosis
```


## Looking under the hood, DIM

```{r underhood-dim, height=6, echo=FALSE}
sim.out <- diagnosis$simulations 
hist(sim.out$estimate[sim.out$estimator=="DIM"],
     main="Randomization Distribution",
     xlab="Estimates in Realized Experiments",
     xlim=c(-0.05,-0.35), cex=24)
abline(v=-0.19, lwd=3, col="red") 
```

## Looking under the hood, DID

```{r underhood-did, height=6, echo=FALSE}
sim.out <- diagnosis$simulations 
hist(sim.out$estimate[sim.out$estimator=="DID"],
     main="Randomization Distribution",
     xlab="Estimates in Realized Experiments",
     xlim=c(-0.05,-0.35), cex=24)
abline(v=-0.19, lwd=3, col="red")
```

## modify_design()

```{r more-sample}
samp_size <- 200 #Redefining our sample size to 200 waterways
sampling2 <- 
  declare_sampling(S = draw_rs(N=N, n=samp_size)) #Re-specifying sampling strategy.
design2 <- population + potential_outcomes + sampling2 +
          assigning + revealing + estimand + dim + did
```

## diagnose_design()

Diagnosing the design with twice the initial sample size

```{r diagnosis2}
diagnosis2 <- diagnose_design(design2, sims=1000) #Diagnosing the design over 1000 simulations to estimate bias and to calculate power.
diagnosis2$diagnosands_df[,c(1,3,5,9,11)] %>%
  kable()

diagnosis2
```


## Looking under the hood, DIM

```{r underhood-dim2, height=6, echo=FALSE}
sim.out <- diagnosis2$simulations
hist(sim.out$estimate[sim.out$estimator=="DIM"],
     main="Randomization Distribution",
     xlab="Estimates in Realized Experiments",
     xlim=c(-0.05,-0.35), cex=24)
abline(v=-0.19, lwd=3, col="red")
```

## Looking under the hood, DID

```{r underhood-did2, height=6, echo=FALSE}
sim.out <- diagnosis2$simulations
hist(sim.out$estimate[sim.out$estimator=="DID"],
     main="Randomization Distribution",
     xlab="Estimates in Realized Experiments",
     xlim=c(-0.05,-0.35), cex=24)
abline(v=-0.19, lwd=3, col="red")
```

## redesign()
What is the minimum sample size required to conduct a sufficiently powered evaluation using each estimator?
```{r other-sample-sizes1}
diagnoses <- design %>% 
  redesign(samp_size=seq(10,100,5)) %>% 
  diagnose_design(sims=100)

diagnoses
```

## redesign()
What is the minimum sample size required to conduct a sufficiently powered evaluation using each estimator?
```{r other-sample-sizes2, height=6, echo=FALSE}
diagnoses$diagnosands_df %>% # and here
  ggplot(aes(x=samp_size,y=power)) +
  geom_hline(aes(yintercept=1.1), lty="dotted", col="red", size=0.5) +
  geom_point() +
  scale_y_continuous(limits=c(0, 2)) +
  theme(text=element_text(size=13)) +
  facet_grid(.~estimator)
```


## redesign()
How strong does treatment need to be for our evaluation to be sufficiently powered, given a fixed sample size of 100?
```{r other-mde1}
diagnoses2 <- design %>% 
  redesign(eff_size=seq(-0.2, 0, 0.02)) %>% 
  diagnose_design(sims=100)

```

## redesign()
How strong does treatment need to be for our evaluation to be sufficiently powered, given a fixed sample size of 100?
```{r other-mde2, height=6, echo=FALSE}
diagnoses2$diagnosands_df %>% # trouble here
  ggplot(aes(x=eff_size,y=power)) +
  geom_hline(aes(yintercept=0.8), lty="dotted", col="red", size=0.5) +
  geom_point() +
  scale_y_continuous(limits=c(0, 1)) +
  theme(text=element_text(size=13)) +
  facet_grid(.~estimator)
```